# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с TS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных используемых в приложении: 
Интерфейс  `ILotItem` описывает товар подгруженный с сервера:
```
  id: string; уникальный id  товара;
  title: string; название товара;
  price: number | null; указывает цену товара или бесценность;
  category: string; категория товара;
  description: string; описание товара;
  image: string; url картинки товара;
```

Интерфейс  `ILots` описывает массив товаров интернет-магазина:
```  
  lots: ILotItem[]; 
```

Интерфейс `IOrderForm` описывает поля форм для заказа товаров:
```
  payment: string; метод оплаты;
  email: string; электронная почта;
  phone: string; контактный телефон;
  address: string; домашний адрес доставки;
```

Интерфейс `IOrderLots` для :
```
  lots: string[]; массив товаров;
  total: number; общая сумма;
```

Интерфейс `IOrder` описания результата заказа:
```
  id: string; идентификатор заказа;
  totalCost: number; общая сумма;
```

Данные пользователя при оформление заказа в модальном окне почты и контактного телефона:

```
type TUserInfoEmailPhone = Pick<IOrderForm, 'email' | 'phone'>;
```

Данные пользователя при оформление заказа в модальном окне выбора способа оплаты и адреса доставки:

```
type TUserInfoAddressPayment = Pick<IOrderForm, 'address' | 'payment'>;
```

Данные товаров при оформление списка покупок в корзине: 
```
type TBasket = Pick<ILotItem, 'id' | 'title' | 'price'>;
```
Необязательные символы `IOrderForm`
```
type FormErrors = Partial<Record<keyof IOrderForm, string>>;
```
Методы отправки Апи:
```
export type ApiPostMethods = 'POST' | 'PUT' | 'DELETE';
```

Интерфейс `IDataBasket` описывает поле и методы товаров добавленных в корзину товаров интернет-магазина:
```
  lots: TBasket[]; массив товаров интернет магазина;
  addLotBasket(lot: TBasket): void; добавляет один лот товара в корзину;
  deleteLotBasket(lotId: string): void; удаляет один лот товара из корзины;
  clearBasket(): void; очистить корзину; 
  getLotsBasket(): string[]; получить массив товаров в корзине;
  getCountLotsBasket(): number; получить количество товаров в корзине;
  getTotalCost(): number; получить общую стоимость товаров в корзине;
  checkBasket(lotId: string): boolean; проверить наличие товара в корзине;
```

## Архитектура приложения 

Код приложения разделён на слои согласно парадигме MVP:
- слой данных, отвечает за хранение и изменение данных,
- слой представения, отвечает за отображение данных на страниице, 
- слой презентера, отвечает за связь слоев данных и представления.

### Базовый код

#### Класс Api 
Класс `Api` предоставляет методы для выполнения стандартных HTTP-запросов (GET и POST) и обработки ответов.

`constructor(baseUrl: string, options: RequestInit = {})`
принимает базовый URL и глобальные опции для всех запросов(опционально).

Методы:
- `get(uri: string);` выполняет GET запрос на переданный в параметрах endpoint  и возращает promise  с объектом, которым ответил сервер;
- `post(uri: string, data: object, method: ApiPostMethods = 'POST');` принимает объект с данными, которые будут переданы в JSON  в теле запроса, и отправляет эти данные на endpoint переданный как парметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределён заданием третьего параметра при вызове;
- `handleResponse(response: Response): Promise<object>;` обрабатывает ответ от сервера, возвращает JSON, если ответ успешный. Отклоняет промис с ошибкой, если ответ не успешный;
 
#### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.

`constructor() {this._events = new Map<EventName, Set<Subscriber>>();}`
присваивает `_events` как новый объект `Map`, который будет использоваться для хранения событий и их обработчиков.

Методы, реализуемые классом  описаны интерфейсом `IEvents`:
- `on` - для подписки на событие.
- `emit` - уведомления подписчиков о наступлении события соответственно.
- `trigger` - генерирует заданное событие с заданными аргументами. Это позволяет передавать его в качестве обработчика события в другие классы. Эти классы будут генерировать события, не будучи при этом напрямую зависимыми от класса EventEmitter.

#### Класс Model<T>
Абстрактные класс дженерик, обощающий в себе конструктор и метод привязки события.  

`constructor(data: Partial<T>, protected events: IEvents);` 
принимает на вход объект данных неявного типа и объект события типа `IEvent`, производит слияние входящего объекта с родительским;

Метод :
- `emitChanges(event: string, payload?: object);` сообщение что модель поменялась;

#### Класс Component<T>
Абстрактные класс дженерик, обобщающий в себе конструктор и основные методы работы с компонентами отображения. 

`constructor(protected readonly container: HTMLElement);`
принимает на вход `container` типа `HTMLElement`


- `toggleClass(element: HTMLElement, className: string, force?: boolean);` переключить класс;
- `setText(element: HTMLElement, value: unknown);` установить текстовое содержимое;
- `setDisabled(element: HTMLElement, state: boolean);` сменить статус блокировки;
- `setHidden(element: HTMLElement);` скрыть;
- `setVisible(element: HTMLElement);` показать;
- `setImage(element: HTMLImageElement, src: string, alt?: string);` установить изображение с алтернативным текстом;
- `render(data?: Partial<T>): HTMLElement;` вернуть корневой DOM-элемент;

### Слой данных

#### Класс Lots
Класс  `Lots` наследует функциональность от Modal и отвечает за хранение и логику работы с данными товаров интернет-магазина.

В полях класса хранятся следующие данные:
- `_catalog: ILotItem[];` массив каталога товаров;
- `_preview: string | null;` id карточки, выбранной для просмотра в модальной окне;

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- `set catalog(lots: ILotItem[]);` устанавливает обработчик события изменения товаров интернет-магазина;
- `set preview(lotId: string | null);` ;устанавливает обработчик события изменения выбранного товара интернет-магазина;
- `get preview();` возвращает id выбранной карточки;
- `getLotItem(lotId: string): ILotItem;` возвращает карточку по ее id;
- `getLots();` возвращает массив товаров интернет-магазина;

#### Класс BasketLot
Класс `BasketLot` наследует функциональность от Modal и отвечает за работу с данными, связанными с корзиной, включая добавление и удаление товаров.

В полях класса хранятся следующие данные:
- `lotsBasket : TBasket[];` массив товаров интернет магазина.

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- `set lots(lots: TBasket[])` устанавливает обработчик события изменения корзины и изменяет корзину;
- `get lots();` получение текущего списка товаров в корзине;
- `addLotBasket(lot: ILotItem): void;` добавляет один лот товара в корзину;
- `deleteLotBasket(lotId: ILotItem): void;` удаляет один лот товара из корзины;
- `clearBasket(): void;` очистить корзину;
- `getLotsBasket(): string[];` получить массив товаров в корзине;
- `getCountLotsBasket(): number;` получить количество товаров в корзине;
- `getTotalCost(): number;` получить общую стоимость товаров в корзине;
- `checkBasket(lotId: string): boolean;` проверить наличие товара в корзине;

#### Класс OrderLot
Класс `OrderLot` наследует функциональность от Modal и отвечает за хранение и логику работы с данными оформленных товаров интернет-магазина.

В полях класса хранятся следующие данные:
- `orderEmailPhone: TUserInfoEmailPhone;` объект с данными контактной информации заказа
- `orderAddressPayment: TUserInfoAddressPayment;` объект с данными адреса заказа и способом оплаты;
- `formErrors: FormErrors = {};` - объект с ошибками форм;

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- `setAddressPayment(field: keyof TUserInfoAddressPayment, value: string): void;` устанавливает данные адреса заказа и способа оплаты;
- `validateAddressPayment(): boolean;` валидация формы адреса и способа оплаты;
- `setEmailPhone(field: keyof TUserInfoEmailPhone, value: string): void;` устанавливает данные контактной информации заказа;
- `validateEmailPhone(): boolean;` валидация формы email и телефона;
- `clearAddressPayment(): void;` очистка формы адреса и способа оплаты;
- `clearEmailPhone(): void;` очистка формы email  и контактного телефона;

### Классы представления
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Класс Modal
Наследует функциональность от Component и реализует модальное окно. Так же предоставляет методы `open` и `close` для управления отображением модального окна. Устанавливает слушатели на клавиатуру, для закрытия модального окна по Esc, на клик в оверлей и кнопку-крестик для закрытия попапа. 

`constructor(container: HTMLElement, protected events: IEvents);` конструктор принимает HTMLElement, по которому в разметке страницы будет идентифицирова нужный темплейт события.

Поля класса:
- `_closeButton: HTMLButtonElement;` кнопка закрытия модального окна;
- `_content: HTMLElement;` элемент модального окна;

Методы: 
- `handleEscUp(evt: KeyboardEvent);` закрытие модалки через клавишу esc;
- `render();` отрисовка окна на странице;

#### Класс Form
Наследует функциональность от Component и реализует класс для формы. Класс управляет состоянием формы и взаимодействием с ней. Предназначен для обработки валидации формы, отображения ошибок и событий отправки.
`constructor(container: HTMLFormElement);` Конструктор принимает HTMLFormElement, по которому в разметке страницы будет идентифицирова нужная форма.

Поля класса:
 - `_submit: HTMLButtonElement;` защищенное поле для кнопки отправки формы;
 - `_errors: HTMLElement;` защищенное поле для отображения ошибок;

Методы:
 - `set valid(value: boolean);` проверка валидность форм(включает  или отключает клавишу submit);
 - `set errors(value: string);` устанавливает ошибки для форм и обновляет элемент отображения ошибок;
 - `render();` отображает состояние формы, включая валидность, ошибки и вводы;

 ### Класс OrderFormAddressView
Класс наследуется от `Form` и создан для представления формы оплаты и доставки.

`constructor(container: HTMLFormElement, events: IEvents);`
конструктор принимает контейнер формы и события

Поля:
- `_buttonsРayment: HTMLButtonElement[];` - массив кнопок выбора оплаты;

Методы: 
- `set buttonsРayment(name: string);` - cеттер для установки активной кнопки оплаты; 
- `set address(value: string);` - cеттер для установки значения поля адреса;
- `clearbuttonsРayment();` - для очистки активных состояний всех кнопок оплаты;

### Класс OrderFormContactsView
Класс наследуется от `Form` и создан для представления формы контактов заказа.

`constructor(container: HTMLFormElement, events: IEvents);`
конструктор принимает контейнер формы и события.

Методы: 
- `set phone(value: string);` сеттер для установки значения поля телефона;
- `set email(value: string);` сеттер для установки значения поля электронной почты;

#### Класс Page
Класс наследует функциональность от Component и реализует собой главную страницу, на которой отображаются все товары интернет магазина, а также счетчик количества товаров, добавленных в корзину.

`constructor(container: HTMLElement, protected events: IEvents)` Конструктор принимает контейнер, в котором размещаются карточки и события. 
Поля класса:
 - `_counter: HTMLElement;`  элемент для отображения количества товаров в корзине;
 - `_catalog: HTMLElement;` элемент содержащий каталог всех товаров интернет магазина;
 - `_wrapper: HTMLElement;` элемент-обертка для всей страницы;
 - `_basket: HTMLElement;` элемент корзины;

Методы:
- `set counter(value: number);` устанавливает значение счетчика товаров в корзине;
- `set catalog(items: HTMLElement[]);` обновляет каталог товаров, заменяя его содержимое;
 - `set locked(value: boolean);` блокирует или разблокирует страницу;

#### Класс Basket 
Класс наследует функциональность от Component и реализует собой корзину товаров. Отображает добавленные в корзину товары, общую сумму заказа и переход к оформлению заказа. 

`constructor(container: HTMLElement, protected events: IEvents);` конструктор принимает один из товаров интернет-магазина и событие
Поля класса:
 - `_title: HTMLElement;` название товара;
 - `_list: HTMLElement;` список товаров в корзине;
 - `_button: HTMLElement;` кнопка для оформления заказа;
 - `_total: HTMLElement;` вся сумма заказа;

Методы:
- `set items(items: HTMLElement[]);` обновляет содержимое корзины;
- `set title(value:string);` устанавливает название товара в корзине;
- `set total(value: number);` устанавливает общую сумму заказа и отображает её;
- ` set list(value: HTMLElement[]);` cеттер для установки списка карточек товаров в корзине;

#### Класс Card
Класс наследуется от базового класса Component и является базовым классом представления товара

`constructor(container: HTMLElement);` в конструктор класса передается DOM элемент темплейта, что позволяет при необходимости формировать карточки разных вариантов верстки.

Поля:
- `_title: HTMLElement;` заголовок товара;
- `_price: HTMLElement;` цена товара;
- `_category?: HTMLElement;` категория товара;
- `ProductCategoryType: Record<string, string>` объект категорий товаров;

Методы:
- `set title(value: string);` cеттер для установки заголовка товара;
- `set price(value: number | null);` cеттер для установки текста цены товара;
- `set category: HTMLElement;` сеттер для установки категории товара;

Классы `CardBasket, CardList, CardPreview`  наследуется от базового класса `Card` и представляют товар, который находится в разных формах интернет-магазина. 
- `constructor(container: HTMLElement, actions?: ILotActions)`
конструкторы принимают контейнер и действия.
Добавляются уникальные поля и необходимые сеттеры.

#### Класс Success
Класс наследуется от базового класса Component и  реализует собой вывод итоговой формы с поздравлением об успешной оплате выбранных товаров. Выводится информация о стоимости покупки, а так же предлагается закрывать форму и продолжить покупки.

`constructor(container: HTMLElement, protected events: IEvents);` конструктор принимает форму успешного оформления товара и события.

Поля класса:
- `_title: HTMLElement;` элемент заголовка;
- `_total: HTMLElement;` общая сумма заказа;
- `buttonClose: HTMLButtonElement;` кнопка закрытия модального окна;

Метод:
 - `set total(value: HTMLElement);`сеттер для общей суммы заказа;
- `set title(value: string);` сеттер для установки заголовка;
### Слой коммуникации

#### Класс AppApi
Класс реализующий взаимодействие с бэкендом сервиса.
`constructor(cdnApi: string, baseApi: IApi);` 

Поля класса:
- `_baseApi: IApi;` экземпляр класса Api
- `_cdnApi: string;` URL CDN для загрузки изображений

Методы реализующие взаимодействие с бэкендом сервиса:
 - `getLotsApi(): Promise<ILotItem[]>` получение списка товаров;
 - `getLotApi(lotId: string): Promise<ILotItem>` получение по id товар;
 - `postOrderApi(order: IOrderLots): Promise<IOrder>` отправка списка покупок;

## Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

*Список всех событий, которые могут генерироваться в системе:*\
*События изменения данных (генерируются классами моделями данных)*
- `lots:changed` - изменение массива карточек
- `lot:selected` - изменение открываемой в модальном окне картинки карточки

*События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление)*
- `basket:open` - открытие корзины;
- `basket:change` - изменение корзины;
- `basket:delete` - удаление карточки из корзины;
- `basket:submit` - подтверждение данных корзины;
- `modal:open` - открытие модального окна;
- `modal:close` - закрытие модального окна;
- `addressPayment:open` - открытие формы с адресом заказа и способом оплаты;
- `emailPhone:open` - открытие формы с email  и номером телефона;
- `formErrorsAddress:change` - изменение формы с адресом заказа и способом оплаты;
- `formErrorsContacts:change` - изменение формы с email  и номером телефона;
- `orderaddress:ready` - подтверждение валидации формы с адресом заказа и способом оплаты;
- `ordercontacts:ready` - подтверждение валидации формы с email  и номером телефона;
- `order:submit` - подтверждение формы с адресом заказа и способом оплаты;
- `form-adress:open` - открытие первой формы с адресом заказа и способом оплаты
- `form-contacts:open` - открытие второй формы с номерами телефонов и email
- `contacts:submit` - подтверждение и отправка заказа на сервер
- `success:close` - закрытие модального окна успшеного оформления заказа.
